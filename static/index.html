<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chocolate Factory - Dashboard</title>
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <div class="header">
        <h1>
            <span>üç´</span>
            Chocolate Factory - Linares, Andaluc√≠a
        </h1>
        <p>Dashboard - ML con Datos Hist√≥ricos (SIAR 88k + REE 42k)</p>
    </div>

    <div class="container">
        <div class="status-bar">
            <div>
                <span id="status" class="status-badge status-warning">üîÑ Conectando...</span>
            </div>
            <div>
                <span>√öltima actualizaci√≥n: <strong id="last-update">--</strong></span>
            </div>
            <div>
                <button class="refresh-btn" onclick="loadData()">üîÑ Actualizar</button>
            </div>
        </div>

        <!-- M√©tricas principales -->
        <div class="grid grid-3">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">‚ö°</span>
                    <span class="card-title">Precio Energ√≠a</span>
                </div>
                <div class="metric-value" id="energy-price">--</div>
                <div class="metric-label">‚Ç¨/kWh</div>
                <div id="energy-trend" class="metric-trend trend-stable">--</div>
                <div style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                    <div>MWh: <span id="energy-mwh">--</span></div>
                    <div>Fecha: <span id="energy-datetime">--</span></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">üå°Ô∏è</span>
                    <span class="card-title">Condiciones Clim√°ticas</span>
                </div>
                <div class="metric-value" id="temperature">--</div>
                <div class="metric-label">¬∞C</div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                    <div>üíß Humedad: <span id="humidity">--%</span></div>
                    <div>üå´Ô∏è Presi√≥n: <span id="pressure">-- hPa</span></div>
                    <div>üéØ Confort: <span id="comfort-index">--</span></div>
                </div>
            </div>

            <!-- Tarjeta Informaci√≥n del Sistema Unificada -->
            <div class="card system-info-unified">
                <div class="card-header">
                    <span class="card-icon">üè≠</span>
                    <span class="card-title">Informaci√≥n del Sistema</span>
                </div>

                <div class="unified-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <!-- Ubicaci√≥n -->
                    <div>
                        <strong style="display: block; margin-bottom: 0.5rem; color: #f59e0b;">üìç F√°brica</strong>
                        <div style="font-size: 0.9rem; line-height: 1.3;">
                            <div>üè≠ Linares, Andaluc√≠a</div>
                            <div>‚õ∞Ô∏è 515m ‚Ä¢ üïê CET</div>
                            <div style="font-size: 0.8rem; opacity: 0.7;">38.151¬∞N, -3.629¬∞W</div>
                        </div>
                    </div>

                    <!-- Estado Operativo -->
                    <div>
                        <strong style="display: block; margin-bottom: 0.5rem; color: #10b981;">üè≠ Estado</strong>
                        <div style="font-size: 0.9rem; line-height: 1.3;">
                            <div id="production-status">üü¢ Operativo</div>
                            <div>üìä Eficiencia: <span id="factory-efficiency">85%</span></div>
                        </div>
                    </div>
                </div>

                <div class="unified-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.2);">
                    <!-- Sistema -->
                    <div>
                        <strong style="display: block; margin-bottom: 0.5rem; color: #3b82f6;">‚öôÔ∏è Sistema</strong>
                        <div style="font-size: 0.85rem; line-height: 1.3;">
                            <div>‚ö° <span id="ree-status">‚úÖ REE + Hist√≥ricos</span></div>
                            <div>üå°Ô∏è <span id="weather-status">‚úÖ AEMET/OpenWeather</span></div>
                            <div>ü§ñ <span id="ml-models-status">‚úÖ Enhanced ML</span></div>
                        </div>
                    </div>

                    <!-- Fuentes de Datos -->
                    <div>
                        <strong style="display: block; margin-bottom: 0.5rem; color: #8b5cf6;">üìä Fuentes</strong>
                        <div style="font-size: 0.85rem; line-height: 1.3;">
                            <div>‚ö° REE (Precios)</div>
                            <div>üå°Ô∏è AEMET 5279X (00-07h)</div>
                            <div>‚òÅÔ∏è OpenWeather (08-23h)</div>
                            <div>ü§ñ ML Direct</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HOURLY OPTIMIZATION -->
        <div class="card" style="margin-top: 2rem; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white;">
            <div class="card-header">
                <span class="card-icon">üéØ</span>
                <span class="card-title" style="color: white;">Plan Optimizado 24h</span>
            </div>

            <!-- Optimization Summary -->
            <div class="grid grid-3" style="gap: 1rem; margin-top: 1.5rem;">
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">üí∞ Ahorro Estimado</div>
                    <div style="font-size: 1.8rem; font-weight: bold;" id="opt-savings-eur">-- ‚Ç¨</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;"><span id="opt-savings-percent">--%</span> vs baseline</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">üì¶ Batches Programados</div>
                    <div style="font-size: 1.8rem; font-weight: bold;" id="opt-num-batches">--</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;"><span id="opt-target-kg">--</span> kg objetivo</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">‚ö° Costo Energ√©tico</div>
                    <div style="font-size: 1.8rem; font-weight: bold;" id="opt-total-cost">-- ‚Ç¨</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;"><span id="opt-total-energy">--</span> kWh</div>
                </div>
            </div>

            <!-- Batches Timeline -->
            <div style="margin-top: 1.5rem; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                <h4 style="color: white; margin-bottom: 1rem; font-size: 1rem;">üìÖ Timeline Producci√≥n Optimizada</h4>
                <div id="opt-batches-timeline" style="max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; padding: 2rem; opacity: 0.7;">
                        ‚è≥ Cargando plan optimizado...
                    </div>
                </div>
            </div>

            <!-- Hourly Timeline 24h (NEW) -->
            <div style="margin-top: 1.5rem; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                <h4 style="color: white; margin-bottom: 1rem; font-size: 1rem;">üïê Vista Horaria 24h - Precio + Periodo + Producci√≥n</h4>
                <div id="hourly-timeline-container" style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
                    <div style="text-align: center; padding: 2rem; opacity: 0.7;">
                        ‚è≥ Cargando timeline horaria...
                    </div>
                </div>
            </div>

            <!-- Optimization Recommendations -->
            <div style="margin-top: 1.5rem; background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; border-left: 4px solid #4CAF50;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;">üí° Recomendaciones de Optimizaci√≥n:</div>
                <div id="opt-recommendations" style="font-size: 0.9rem; line-height: 1.6;">
                    <div>‚è≥ Calculando recomendaciones...</div>
                </div>
            </div>

            <!-- Baseline Comparison -->
            <div style="margin-top: 1.5rem; background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;">
                <h4 style="color: white; margin-bottom: 1rem; font-size: 0.95rem; opacity: 0.9;">üìä Comparativa Baseline vs Optimizado</h4>
                <div class="grid grid-2" style="gap: 1rem; font-size: 0.85rem;">
                    <div>
                        <strong style="color: #FF9800;">üìç Baseline (horario fijo 08-16h):</strong>
                        <div style="margin-top: 0.5rem; line-height: 1.6; opacity: 0.9;">
                            <div>Costo: <span id="baseline-cost">-- ‚Ç¨</span></div>
                            <div>Energ√≠a: <span id="baseline-energy">-- kWh</span></div>
                            <div>Precio promedio: <span id="baseline-avg-price">-- ‚Ç¨/kWh</span></div>
                        </div>
                    </div>
                    <div>
                        <strong style="color: #4CAF50;">‚ú® Optimizado (precio + clima):</strong>
                        <div style="margin-top: 0.5rem; line-height: 1.6; opacity: 0.9;">
                            <div>Costo: <span id="optimized-cost">-- ‚Ç¨</span></div>
                            <div>Energ√≠a: <span id="optimized-energy">-- kWh</span></div>
                            <div>Precio promedio: <span id="optimized-avg-price">-- ‚Ç¨/kWh</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Refresh Button -->
            <div style="margin-top: 1.5rem; text-align: center;">
                <button onclick="loadOptimizationPlan()" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); color: white; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: bold; transition: all 0.3s;">
                    üîÑ Recalcular Plan Optimizado
                </button>
            </div>
        </div>

        <!-- Mini Calendario Heatmap Semanal -->
        <div class="card heatmap-card" style="margin-top: 2rem;">
            <div class="card-header">
                <span class="card-icon">üìÖ</span>
                <span class="card-title">Pron√≥stico Semanal - Heatmap de Precios</span>
            </div>
            <div class="heatmap-content">
                <div class="heatmap-legend" id="heatmap-legend">
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #4CAF50;"></span>
                        <span>üü¢ Bajo (‚â§0.10 ‚Ç¨/kWh)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #FF9800;"></span>
                        <span>üü° Medio (0.10-0.20 ‚Ç¨/kWh)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #F44336;"></span>
                        <span>üî¥ Alto (>0.20 ‚Ç¨/kWh)</span>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Se llena din√°micamente con JavaScript -->
                </div>
                <div class="heatmap-summary" id="heatmap-summary">
                    <div class="summary-item">
                        <span class="summary-label">D√≠as √ìptimos:</span>
                        <span id="optimal-days">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Precio Promedio:</span>
                        <span id="avg-price">0.000 ‚Ç¨/kWh</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Rango:</span>
                        <span id="price-range">0.00 - 0.00 ‚Ç¨/kWh</span>
                    </div>
                </div>
            </div>

            <!-- M√©tricas Hist√≥ricas Integradas -->
            <div class="grid grid-3" style="gap: 1.5rem; margin-top: 1.5rem; padding: 1.5rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                <div class="analytics-section">
                    <h4 style="color: #66BB6A; margin-bottom: 1rem; font-size: 0.9rem;">üìä Hist√≥ricos 2024</h4>
                    <div class="analytics-metric" style="margin-bottom: 0.5rem;">
                        <span class="metric-label" style="font-size: 0.8rem; color: #333;">Costo Total:</span>
                        <span class="metric-value" style="color: #333; font-size: 0.9rem;" id="total-cost">-- ‚Ç¨</span>
                    </div>
                    <div class="analytics-metric" style="margin-bottom: 0.5rem;">
                        <span class="metric-label" style="font-size: 0.8rem; color: #333;">Min/Max:</span>
                        <span class="metric-value" style="color: #333; font-size: 0.9rem;" id="min-max-price">--/-- ‚Ç¨/kWh</span>
                    </div>
                </div>

                <div class="analytics-section">
                    <h4 style="color: #2196F3; margin-bottom: 1rem; font-size: 0.9rem;">üéØ Potencial</h4>
                    <div class="analytics-metric" style="margin-bottom: 0.5rem;">
                        <span class="metric-label" style="font-size: 0.8rem; color: #333;">Ahorro Anual:</span>
                        <span class="metric-value" style="color: #333; font-size: 0.9rem;" id="annual-projection">-- ‚Ç¨</span>
                    </div>
                    <div class="analytics-metric" style="margin-bottom: 0.5rem;">
                        <span class="metric-label" style="font-size: 0.8rem; color: #333;">Horas √ìptimas:</span>
                        <span class="metric-value" style="color: #333; font-size: 0.9rem;" id="optimal-hours">-- h</span>
                    </div>
                </div>

                <div class="analytics-section">
                    <h4 style="color: #FF9800; margin-bottom: 1rem; font-size: 0.9rem;">üí° Recomendaciones</h4>
                    <div id="unified-optimization-recommendations" style="font-size: 0.8rem; line-height: 1.4; color: #333;">
                        <!-- Recomendaciones unificadas -->
                    </div>
                </div>
            </div>
        </div>

        <!-- SIAR Historical Analysis -->
        <div class="card" style="margin-top: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="card-header">
                <span class="card-icon">üìä</span>
                <span class="card-title">An√°lisis Hist√≥rico SIAR (2000-2025)</span>
            </div>

            <!-- SIAR Summary Stats -->
            <div class="grid grid-3" style="gap: 1rem; margin-top: 1.5rem;">
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">üìà Registros Totales</div>
                    <div style="font-size: 1.8rem; font-weight: bold;" id="siar-total-records">--</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;" id="siar-date-range">--</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">üå°Ô∏è Correlaci√≥n Temp</div>
                    <div style="font-size: 1.8rem; font-weight: bold;" id="siar-temp-correlation">--</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">R¬≤ vs Producci√≥n</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">üíß Correlaci√≥n Humedad</div>
                    <div style="font-size: 1.8rem; font-weight: bold;" id="siar-humidity-correlation">--</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">R¬≤ vs Producci√≥n</div>
                </div>
            </div>

            <!-- Seasonal Patterns -->
            <div style="margin-top: 1.5rem; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                <h4 style="color: white; margin-bottom: 1rem; font-size: 1rem;">üìÖ Patrones Estacionales</h4>
                <div class="grid grid-2" style="gap: 1rem;">
                    <div>
                        <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">üü¢ Mejor Mes:</div>
                        <div style="font-size: 1.1rem; font-weight: bold;" id="siar-best-month">--</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;" id="siar-best-month-score">--</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">üî¥ Peor Mes:</div>
                        <div style="font-size: 1.1rem; font-weight: bold;" id="siar-worst-month">--</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;" id="siar-worst-month-score">--</div>
                    </div>
                </div>
            </div>

            <!-- Critical Thresholds -->
            <div style="margin-top: 1.5rem; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                <h4 style="color: white; margin-bottom: 1rem; font-size: 1rem;">‚ö†Ô∏è Umbrales Cr√≠ticos (Percentiles Hist√≥ricos)</h4>
                <div class="grid grid-2" style="gap: 1rem; font-size: 0.9rem;">
                    <div>
                        <strong>üå°Ô∏è Temperatura:</strong>
                        <div style="margin-top: 0.5rem; line-height: 1.6;">
                            <div>P90: <span id="siar-temp-p90">--</span>¬∞C</div>
                            <div>P95: <span id="siar-temp-p95">--</span>¬∞C</div>
                            <div>P99: <span id="siar-temp-p99">--</span>¬∞C</div>
                        </div>
                    </div>
                    <div>
                        <strong>üíß Humedad:</strong>
                        <div style="margin-top: 0.5rem; line-height: 1.6;">
                            <div>P90: <span id="siar-humidity-p90">--</span>%</div>
                            <div>P95: <span id="siar-humidity-p95">--</span>%</div>
                            <div>P99: <span id="siar-humidity-p99">--</span>%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SIAR Insights -->
            <div style="margin-top: 1.5rem; background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; border-left: 4px solid #FFD700;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;">üí° Insights Hist√≥ricos:</div>
                <div id="siar-insights" style="font-size: 0.9rem; line-height: 1.6;">
                    <div>‚è≥ Cargando an√°lisis hist√≥rico...</div>
                </div>
            </div>
        </div>

    </div>

    <div class="footer">
        Chocolate Factory - Linares, Andaluc√≠a | Dashboard v0.42.0 (Sprint 08) |
        Powered by FastAPI + ML (131k+ Historical Records) + Hourly Optimization
    </div>

    <script src="js/dashboard.js?v=0.42.0"></script>
</body>
</html>

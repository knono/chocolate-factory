<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chocolate Factory - Dashboard</title>
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <div class="header">
        <h1>
            <span>üç´</span>
            Chocolate Factory - Linares, Andaluc√≠a
        </h1>
        <p>Dashboard - ML con Datos Hist√≥ricos (SIAR 88k + REE 42k)</p>
    </div>

    <div class="container">
        <div class="status-bar">
            <div>
                <span id="status" class="status-badge status-warning">üîÑ Conectando...</span>
            </div>
            <div>
                <span>√öltima actualizaci√≥n: <strong id="last-update">--</strong></span>
            </div>
            <div>
                <button class="refresh-btn" onclick="loadData()">üîÑ Actualizar</button>
            </div>
        </div>

        <!-- M√©tricas principales -->
        <div class="grid grid-3">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">‚ö°</span>
                    <span class="card-title">Precio Energ√≠a</span>
                </div>
                <div class="metric-value" id="energy-price">--</div>
                <div class="metric-label">‚Ç¨/kWh</div>
                <div id="energy-trend" class="metric-trend trend-stable">--</div>
                <div style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                    <div>MWh: <span id="energy-mwh">--</span></div>
                    <div>Fecha: <span id="energy-datetime">--</span></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span class="card-icon">üå°Ô∏è</span>
                    <span class="card-title">Condiciones Clim√°ticas</span>
                </div>
                <div class="metric-value" id="temperature">--</div>
                <div class="metric-label">¬∞C</div>
                <div style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                    <div>üíß Humedad: <span id="humidity">--%</span></div>
                    <div>üå´Ô∏è Presi√≥n: <span id="pressure">-- hPa</span></div>
                    <div>üéØ Confort: <span id="comfort-index">--</span></div>
                </div>
            </div>

            <!-- Tarjeta Informaci√≥n del Sistema Unificada -->
            <div class="card system-info-unified">
                <div class="card-header">
                    <span class="card-icon">üè≠</span>
                    <span class="card-title">Informaci√≥n del Sistema</span>
                </div>

                <div class="unified-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <!-- Ubicaci√≥n -->
                    <div>
                        <strong style="display: block; margin-bottom: 0.5rem; color: #f59e0b;">üìç F√°brica</strong>
                        <div style="font-size: 0.9rem; line-height: 1.3;">
                            <div>üè≠ Linares, Andaluc√≠a</div>
                            <div>‚õ∞Ô∏è 515m ‚Ä¢ üïê CET</div>
                            <div style="font-size: 0.8rem; opacity: 0.7;">38.151¬∞N, -3.629¬∞W</div>
                        </div>
                    </div>

                    <!-- Estado Operativo -->
                    <div>
                        <strong style="display: block; margin-bottom: 0.5rem; color: #10b981;">üè≠ Estado</strong>
                        <div style="font-size: 0.9rem; line-height: 1.3;">
                            <div id="production-status">üü¢ Operativo</div>
                            <div>üìä Eficiencia: <span id="factory-efficiency">85%</span></div>
                        </div>
                    </div>
                </div>

                <div class="unified-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.2);">
                    <!-- Sistema -->
                    <div>
                        <strong style="display: block; margin-bottom: 0.5rem; color: #3b82f6;">‚öôÔ∏è Sistema</strong>
                        <div style="font-size: 0.85rem; line-height: 1.3;">
                            <div>‚ö° <span id="ree-status">‚úÖ REE + Hist√≥ricos</span></div>
                            <div>üå°Ô∏è <span id="weather-status">‚úÖ AEMET/OpenWeather</span></div>
                            <div>ü§ñ <span id="ml-models-status">‚úÖ Enhanced ML</span></div>
                        </div>
                    </div>

                    <!-- Fuentes de Datos -->
                    <div>
                        <strong style="display: block; margin-bottom: 0.5rem; color: #8b5cf6;">üìä Fuentes</strong>
                        <div style="font-size: 0.85rem; line-height: 1.3;">
                            <div>‚ö° REE (Precios)</div>
                            <div>üå°Ô∏è AEMET 5279X (00-07h)</div>
                            <div>‚òÅÔ∏è OpenWeather (08-23h)</div>
                            <div>ü§ñ ML Direct</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced ML Analytics -->
        <div class="enhanced-section" style="margin: 2rem 0;">
            <div class="enhanced-title">
                <span>üìä</span>
                <span>ML Analytics - Datos Hist√≥ricos Integrados</span>
            </div>

            <div class="grid grid-3" style="gap: 1.5rem;">
                <!-- Cost Optimization -->
                <div class="card metric-enhanced">
                    <div class="card-header">
                        <span class="card-icon">üí∞</span>
                        <span class="card-title">Optimizaci√≥n de Costos</span>
                    </div>
                    <div class="metric-value" id="enhanced-cost-per-kg">--</div>
                    <div class="metric-label">‚Ç¨/kg</div>
                    <div style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                        <div>Categor√≠a: <span id="cost-category">--</span></div>
                        <div>Ahorro: <span id="savings-opportunity">-- ‚Ç¨/kg</span></div>
                        <div>vs Target: <span id="vs-target">--%</span></div>
                    </div>
                </div>

                <!-- Enhanced Recommendations -->
                <div class="card metric-enhanced">
                    <div class="card-header">
                        <span class="card-icon">üéØ</span>
                        <span class="card-title">Recomendaci√≥n Enhanced</span>
                    </div>
                    <div class="metric-value" id="enhanced-main-action">--</div>
                    <div class="metric-label" id="enhanced-priority">--</div>
                    <div style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                        <div>Score: <span id="enhanced-overall-score">--/100</span></div>
                        <div>Confianza: <span id="enhanced-confidence">--</span></div>
                        <div>Alertas: <span id="enhanced-alerts-count">--</span></div>
                    </div>
                </div>

                <!-- REE Deviation Analysis -->
                <div class="card metric-enhanced">
                    <div class="card-header">
                        <span class="card-icon">üìä</span>
                        <span class="card-title">An√°lisis REE D-1</span>
                    </div>
                    <div class="metric-value" id="ree-accuracy">--</div>
                    <div class="metric-label">Precisi√≥n</div>
                    <div style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
                        <div>Desviaci√≥n: <span id="ree-deviation">-- ‚Ç¨/kWh</span></div>
                        <div>Tendencia: <span id="ree-trend">--</span></div>
                        <div>Utilidad: <span id="ree-usefulness">An√°lisis tendencias</span></div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Recommendations List -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <span class="card-icon">üìã</span>
                    <span class="card-title">Recomendaciones Enhanced ML</span>
                </div>
                <div class="grid grid-2" style="gap: 1rem; margin-top: 1rem;">
                    <div>
                        <h4 style="color: #059669; margin-bottom: 0.5rem;">üîß Optimizaci√≥n de Costos:</h4>
                        <ul id="enhanced-cost-insights" style="list-style: none; padding: 0; font-size: 0.9rem; line-height: 1.6;">
                            <li>‚è≥ Cargando insights de costos...</li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="color: #059669; margin-bottom: 0.5rem;">‚ö° Timing Optimization:</h4>
                        <ul id="enhanced-timing-insights" style="list-style: none; padding: 0; font-size: 0.9rem; line-height: 1.6;">
                            <li>‚è≥ Cargando insights temporales...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- An√°lisis REE - Tiempo Real + Hist√≥ricos -->
        <div class="card smart-insights" style="margin-top: 1.5rem;">
            <div class="card-header">
                <span class="card-icon">‚ö°</span>
                <span class="card-title">An√°lisis REE - Tiempo Real + Hist√≥ricos</span>
            </div>

            <!-- Recomendaci√≥n Humanizada Principal -->
            <div id="unified-human-recommendation-section" style="margin-top: 1.5rem; display: none;">
                <div id="unified-human-recommendation-content" style="background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%); color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(255,107,53,0.3);">
                    <!-- Se llena din√°micamente con BusinessLogicService -->
                </div>
            </div>

            <div class="grid grid-3" style="gap: 1.5rem; margin-top: 1.5rem;">
                <!-- Momento √ìptimo Actual -->
                <div class="insights-section">
                    <h4 style="color: #4FC3F7; margin-bottom: 1rem; font-size: 1rem;">‚ö° Momento Energ√©tico Actual</h4>
                    <div class="current-status">
                        <div class="status-indicator" id="current-energy-status">
                            <span class="status-icon">üü°</span>
                            <span class="status-text" id="energy-status-text">Evaluando...</span>
                        </div>
                        <div class="status-detail" id="energy-status-detail">
                            Precio actual: <span id="current-price-analysis">-- ‚Ç¨/kWh</span>
                        </div>
                        <div class="status-action" id="energy-action-recommendation">
                            Calculando recomendaci√≥n...
                        </div>
                    </div>
                </div>

                <!-- Oportunidad de Ahorro -->
                <div class="insights-section">
                    <h4 style="color: #66BB6A; margin-bottom: 1rem; font-size: 1rem;">üí∞ Oportunidad de Ahorro</h4>
                    <div class="savings-insight">
                        <div class="savings-metric">
                            <span class="metric-label">Ahorro vs Precio Promedio:</span>
                            <span class="metric-value" id="current-savings-potential">-- ‚Ç¨/hora</span>
                        </div>
                        <div class="savings-metric">
                            <span class="metric-label">Posici√≥n en Ranking Diario:</span>
                            <span class="metric-value" id="price-ranking">--/24</span>
                        </div>
                        <div class="savings-action" id="savings-action">
                            Analizando oportunidades...
                        </div>
                    </div>
                </div>

                <!-- An√°lisis por Procesos -->
                <div class="insights-section">
                    <h4 style="color: #FF9800; margin-bottom: 1rem; font-size: 1rem;">üè≠ An√°lisis por Procesos</h4>
                    <div class="process-analysis">
                        <div class="process-metric">
                            <span class="metric-label">Proceso Recomendado:</span>
                            <span class="metric-value" id="recommended-process">--</span>
                        </div>
                        <div class="process-metric">
                            <span class="metric-label">Costo Proceso/hora:</span>
                            <span class="metric-value" id="process-cost">-- ‚Ç¨/h</span>
                        </div>
                        <div class="process-action" id="process-action">
                            Calculando procesos...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recomendaci√≥n Inteligente Principal -->
            <div class="main-recommendation" id="main-recommendation" style="margin-top: 1.5rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(46, 125, 50, 0.2) 100%); border-radius: 8px; border-left: 4px solid #4CAF50;">
                <div style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                    <span id="recommendation-icon" style="font-size: 1.5rem; margin-right: 0.75rem;">üéØ</span>
                    <span id="recommendation-title" style="font-weight: bold; color: white;">Analizando condiciones del mercado...</span>
                </div>
                <div id="recommendation-detail" style="color: rgba(255, 255, 255, 0.9); line-height: 1.5;">
                    Evaluando precios REE hist√≥ricos y condiciones actuales para optimizar el momento de producci√≥n...
                </div>
            </div>
        </div>

        <!-- Mini Calendario Heatmap Semanal -->
        <div class="card heatmap-card" style="margin-top: 2rem;">
            <div class="card-header">
                <span class="card-icon">üìÖ</span>
                <span class="card-title">Pron√≥stico Semanal - Heatmap de Precios</span>
            </div>
            <div class="heatmap-content">
                <div class="heatmap-legend" id="heatmap-legend">
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #4CAF50;"></span>
                        <span>üü¢ Bajo (‚â§0.10 ‚Ç¨/kWh)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #FF9800;"></span>
                        <span>üü° Medio (0.10-0.20 ‚Ç¨/kWh)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #F44336;"></span>
                        <span>üî¥ Alto (>0.20 ‚Ç¨/kWh)</span>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Se llena din√°micamente con JavaScript -->
                </div>
                <div class="heatmap-summary" id="heatmap-summary">
                    <div class="summary-item">
                        <span class="summary-label">D√≠as √ìptimos:</span>
                        <span id="optimal-days">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Precio Promedio:</span>
                        <span id="avg-price">0.000 ‚Ç¨/kWh</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Rango:</span>
                        <span id="price-range">0.00 - 0.00 ‚Ç¨/kWh</span>
                    </div>
                </div>
            </div>

            <!-- M√©tricas Hist√≥ricas Integradas -->
            <div class="grid grid-3" style="gap: 1.5rem; margin-top: 1.5rem; padding: 1.5rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                <div class="analytics-section">
                    <h4 style="color: #66BB6A; margin-bottom: 1rem; font-size: 0.9rem;">üìä Hist√≥ricos 2024</h4>
                    <div class="analytics-metric" style="margin-bottom: 0.5rem;">
                        <span class="metric-label" style="font-size: 0.8rem; color: #333;">Costo Total:</span>
                        <span class="metric-value" style="color: #333; font-size: 0.9rem;" id="total-cost">-- ‚Ç¨</span>
                    </div>
                    <div class="analytics-metric" style="margin-bottom: 0.5rem;">
                        <span class="metric-label" style="font-size: 0.8rem; color: #333;">Min/Max:</span>
                        <span class="metric-value" style="color: #333; font-size: 0.9rem;" id="min-max-price">--/-- ‚Ç¨/kWh</span>
                    </div>
                </div>

                <div class="analytics-section">
                    <h4 style="color: #2196F3; margin-bottom: 1rem; font-size: 0.9rem;">üéØ Potencial</h4>
                    <div class="analytics-metric" style="margin-bottom: 0.5rem;">
                        <span class="metric-label" style="font-size: 0.8rem; color: #333;">Ahorro Anual:</span>
                        <span class="metric-value" style="color: #333; font-size: 0.9rem;" id="annual-projection">-- ‚Ç¨</span>
                    </div>
                    <div class="analytics-metric" style="margin-bottom: 0.5rem;">
                        <span class="metric-label" style="font-size: 0.8rem; color: #333;">Horas √ìptimas:</span>
                        <span class="metric-value" style="color: #333; font-size: 0.9rem;" id="optimal-hours">-- h</span>
                    </div>
                </div>

                <div class="analytics-section">
                    <h4 style="color: #FF9800; margin-bottom: 1rem; font-size: 0.9rem;">üí° Recomendaciones</h4>
                    <div id="unified-optimization-recommendations" style="font-size: 0.8rem; line-height: 1.4; color: #333;">
                        <!-- Recomendaciones unificadas -->
                    </div>
                </div>
            </div>
        </div>

        <!-- SIAR Historical Analysis -->
        <div class="card" style="margin-top: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="card-header">
                <span class="card-icon">üìä</span>
                <span class="card-title">An√°lisis Hist√≥rico SIAR (2000-2025)</span>
            </div>

            <!-- SIAR Summary Stats -->
            <div class="grid grid-3" style="gap: 1rem; margin-top: 1.5rem;">
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">üìà Registros Totales</div>
                    <div style="font-size: 1.8rem; font-weight: bold;" id="siar-total-records">--</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;" id="siar-date-range">--</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">üå°Ô∏è Correlaci√≥n Temp</div>
                    <div style="font-size: 1.8rem; font-weight: bold;" id="siar-temp-correlation">--</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">R¬≤ vs Producci√≥n</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                    <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">üíß Correlaci√≥n Humedad</div>
                    <div style="font-size: 1.8rem; font-weight: bold;" id="siar-humidity-correlation">--</div>
                    <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">R¬≤ vs Producci√≥n</div>
                </div>
            </div>

            <!-- Seasonal Patterns -->
            <div style="margin-top: 1.5rem; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                <h4 style="color: white; margin-bottom: 1rem; font-size: 1rem;">üìÖ Patrones Estacionales</h4>
                <div class="grid grid-2" style="gap: 1rem;">
                    <div>
                        <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">üü¢ Mejor Mes:</div>
                        <div style="font-size: 1.1rem; font-weight: bold;" id="siar-best-month">--</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;" id="siar-best-month-score">--</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; margin-bottom: 0.5rem;">üî¥ Peor Mes:</div>
                        <div style="font-size: 1.1rem; font-weight: bold;" id="siar-worst-month">--</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;" id="siar-worst-month-score">--</div>
                    </div>
                </div>
            </div>

            <!-- Critical Thresholds -->
            <div style="margin-top: 1.5rem; background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
                <h4 style="color: white; margin-bottom: 1rem; font-size: 1rem;">‚ö†Ô∏è Umbrales Cr√≠ticos (Percentiles Hist√≥ricos)</h4>
                <div class="grid grid-2" style="gap: 1rem; font-size: 0.9rem;">
                    <div>
                        <strong>üå°Ô∏è Temperatura:</strong>
                        <div style="margin-top: 0.5rem; line-height: 1.6;">
                            <div>P90: <span id="siar-temp-p90">--</span>¬∞C</div>
                            <div>P95: <span id="siar-temp-p95">--</span>¬∞C</div>
                            <div>P99: <span id="siar-temp-p99">--</span>¬∞C</div>
                        </div>
                    </div>
                    <div>
                        <strong>üíß Humedad:</strong>
                        <div style="margin-top: 0.5rem; line-height: 1.6;">
                            <div>P90: <span id="siar-humidity-p90">--</span>%</div>
                            <div>P95: <span id="siar-humidity-p95">--</span>%</div>
                            <div>P99: <span id="siar-humidity-p99">--</span>%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SIAR Insights -->
            <div style="margin-top: 1.5rem; background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; border-left: 4px solid #FFD700;">
                <div style="font-weight: bold; margin-bottom: 0.5rem;">üí° Insights Hist√≥ricos:</div>
                <div id="siar-insights" style="font-size: 0.9rem; line-height: 1.6;">
                    <div>‚è≥ Cargando an√°lisis hist√≥rico...</div>
                </div>
            </div>
        </div>

    </div>

    <div class="footer">
        Chocolate Factory - Linares, Andaluc√≠a | Dashboard v0.41.0 |
        Powered by FastAPI + ML (131k+ Historical Records)
    </div>

    <script src="js/dashboard.js"></script>
</body>
</html>

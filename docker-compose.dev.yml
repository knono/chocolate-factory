# =============================================================================
# CHOCOLATE FACTORY - DEVELOPMENT ENVIRONMENT
# =============================================================================
# Entorno de desarrollo completo e independiente
# Desplegado en nodo Tailscale: chocolate-factory-dev.azules-elver.ts.net
# Uso: docker compose -f docker-compose.dev.yml up -d
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # FASTAPI APP - DESARROLLO
  # ---------------------------------------------------------------------------
  fastapi-app-dev:
    image: localhost:5000/chocolate-factory:develop
    container_name: chocolate_factory_dev
    ports:
      - "8001:8000"  # Puerto diferente para evitar conflictos
    environment:
      - ENVIRONMENT=development
      - APP_NAME=chocolate-factory-dev
      - LOG_LEVEL=DEBUG
      - TZ=Europe/Madrid
      - PYTHONPATH=/app
      # APIs Externas (usando Docker Secrets)
      - REE_API_TOKEN_FILE=/run/secrets/ree_api_token
      - AEMET_API_KEY_FILE=/run/secrets/aemet_api_key
      - OPENWEATHERMAP_API_KEY_FILE=/run/secrets/openweathermap_api_key
      - ANTHROPIC_API_KEY_FILE=/run/secrets/anthropic_api_key
      # InfluxDB
      - INFLUXDB_URL=http://influxdb-dev:8086
      - INFLUXDB_TOKEN_FILE=/run/secrets/influxdb_token
      - INFLUXDB_ORG=chocolate-factory-dev
      - INFLUXDB_BUCKET=energy_data_dev
    volumes:
      # Código fuente para hot reload (mapeo directo)
      - ./src/fastapi-app/main.py:/app/main.py
      - ./src/fastapi-app/core:/app/core
      - ./src/fastapi-app/api:/app/api
      - ./src/fastapi-app/services:/app/services
      - ./src/fastapi-app/infrastructure:/app/infrastructure
      - ./src/fastapi-app/domain:/app/domain
      - ./src/fastapi-app/tasks:/app/tasks
      - ./src/fastapi-app/dependencies.py:/app/dependencies.py
      # Datos y configuración
      - ./data:/app/data
      - ./models:/app/models
      - ./static:/app/static
      - ./.claude:/app/.claude
      - ./logs/dev:/app/logs
    secrets:
      - ree_api_token
      - aemet_api_key
      - openweathermap_api_key
      - anthropic_api_key
      - influxdb_token
    depends_on:
      - influxdb-dev
    networks:
      - chocolate-factory_backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # INFLUXDB - DESARROLLO
  # ---------------------------------------------------------------------------
  influxdb-dev:
    image: influxdb:2.7
    container_name: influxdb_dev
    ports:
      - "8087:8086"  # Puerto diferente
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USER}
      - DOCKER_INFLUXDB_INIT_PASSWORD_FILE=/run/secrets/influxdb_admin_password
      - DOCKER_INFLUXDB_INIT_ORG=chocolate-factory-dev
      - DOCKER_INFLUXDB_INIT_BUCKET=energy_data_dev
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN_FILE=/run/secrets/influxdb_token
    volumes:
      - influxdb_dev_data:/var/lib/influxdb2
      - influxdb_dev_config:/etc/influxdb2
    secrets:
      - influxdb_token
      - influxdb_admin_password
    networks:
      - chocolate-factory_backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# =============================================================================
# DOCKER SECRETS
# =============================================================================
secrets:
  ree_api_token:
    file: ./docker/secrets/ree_api_token.txt
  aemet_api_key:
    file: ./docker/secrets/aemet_api_key.txt
  openweathermap_api_key:
    file: ./docker/secrets/openweathermap_api_key.txt
  anthropic_api_key:
    file: ./docker/secrets/anthropic_api_key.txt
  influxdb_token:
    file: ./docker/secrets/influxdb_token.txt
  influxdb_admin_password:
    file: ./docker/secrets/influxdb_admin_password.txt

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  influxdb_dev_data:
    driver: local
  influxdb_dev_config:
    driver: local

# =============================================================================
# NETWORK
# =============================================================================
networks:
  chocolate-factory_backend:
    external: true  # Usar la red del compose principal

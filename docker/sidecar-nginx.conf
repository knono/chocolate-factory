events {
    worker_connections 1024;
}

http {
    # Configuraci√≥n b√°sica
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # Upstream hacia FastAPI en red interna Docker
    upstream chocolate_dashboard {
        server chocolate_factory_brain:8000;
    }

    # Servidor HTTPS - Solo Dashboard TFM Chocolate Factory
    server {
        listen 80;
        listen [::]:80;
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name chocolate-factory.azules-elver.ts.net;

        # Certificados SSL autom√°ticos de Tailscale
        ssl_certificate /var/lib/tailscale/certs/chocolate-factory.azules-elver.ts.net.crt;
        ssl_certificate_key /var/lib/tailscale/certs/chocolate-factory.azules-elver.ts.net.key;

        # Configuraci√≥n SSL moderna
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        # Redirecci√≥n HTTP -> HTTPS
        if ($scheme != "https") {
            return 301 https://$host$request_uri;
        }

        # REDIRIGIR ROOT A DASHBOARD
        location = / {
            return 302 /dashboard;
        }

        # SOLO DASHBOARD - Permitir acceso
        location /dashboard {
            proxy_pass http://chocolate_dashboard;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Headers para dashboard din√°mico
            proxy_set_header Connection "upgrade";
            proxy_set_header Upgrade $http_upgrade;
            proxy_cache_bypass $http_upgrade;
        }

        # API endpoints necesarios para el dashboard
        location /dashboard/complete {
            proxy_pass http://chocolate_dashboard;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Permitir recursos est√°ticos del dashboard si existen
        location ~ ^/(static|css|js|images|fonts)/ {
            proxy_pass http://chocolate_dashboard;
            proxy_set_header Host $host;
            add_header Cache-Control "public, max-age=86400";
        }

        # BLOQUEAR TODO LO DEM√ÅS - Seguridad
        location ~ ^/(docs|redoc|openapi\.json|predict|mlflow|ree|aemet|weather|init|gaps|models|scheduler|influxdb) {
            return 403 '<!DOCTYPE html>
<html>
<head>
    <title>TFM Chocolate Factory - Acceso Restringido</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .chocolate { font-size: 4rem; margin-bottom: 1rem; }
        h1 { color: #8B4513; margin-bottom: 0.5rem; }
        h2 { color: #D2691E; margin-bottom: 1.5rem; }
        p { color: #555; font-size: 1.1rem; margin: 1rem 0; }
        .link { color: #0066cc; text-decoration: none; font-weight: bold; padding: 0.5rem 1rem; background: #f0f8ff; border-radius: 6px; display: inline-block; }
        .link:hover { text-decoration: underline; background: #e6f3ff; }
        .restriction { background: #fff3cd; border: 1px solid #ffeaa7; padding: 1rem; border-radius: 6px; margin: 1rem 0; }
        .footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee; color: #888; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="chocolate">üç´</div>
        <h1>TFM Chocolate Factory</h1>
        <h2>F√°brica de Chocolate - Linares, Andaluc√≠a</h2>
        
        <div class="restriction">
            <strong>‚ö†Ô∏è Zona Restringida</strong><br>
            Esta ruta est√° bloqueada por razones de seguridad.
        </div>
        
        <p>Solo el dashboard est√° disponible a trav√©s de esta conexi√≥n segura.</p>
        <p><a href="/dashboard" class="link">üëâ Acceder al Dashboard</a></p>
        
        <div class="footer">
            <div>üåê Acceso v√≠a Tailscale | üîí Solo Dashboard habilitado</div>
            <div>üìç Localizaci√≥n: Linares, Andaluc√≠a, Espa√±a</div>
        </div>
    </div>
</body>
</html>';
        }

        # Bloquear APIs administrativas
        location ~ ^/(admin|api/admin) {
            return 403;
        }

        # Mensaje por defecto para cualquier otra ruta
        location / {
            return 403 '<!DOCTYPE html>
<html>
<head>
    <title>TFM Chocolate Factory - Solo Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 3rem; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        .chocolate { font-size: 5rem; margin-bottom: 1.5rem; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
        h1 { color: #8B4513; margin-bottom: 0.5rem; font-size: 2.5rem; }
        h2 { color: #D2691E; margin-bottom: 2rem; font-weight: 300; }
        .link { color: white; text-decoration: none; font-weight: bold; padding: 1rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50px; display: inline-block; transition: transform 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .link:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.3); }
        .info { margin: 2rem 0; color: #666; }
        .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0; }
        .feature { background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #667eea; }
        .footer { margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #eee; color: #888; }
    </style>
</head>
<body>
    <div class="container">
        <div class="chocolate">üç´</div>
        <h1>TFM Chocolate Factory</h1>
        <h2>Dashboard Seguro - Linares, Andaluc√≠a</h2>
        
        <div class="info">
            <p>Bienvenido al sistema de monitoreo de la f√°brica de chocolate.</p>
            <p>Esta conexi√≥n est√° securizada atrav√©s de Tailscale.</p>
        </div>

        <div class="features">
            <div class="feature">
                <strong>üè≠ Producci√≥n</strong><br>
                <small>Monitoreo en tiempo real</small>
            </div>
            <div class="feature">
                <strong>‚ö° Energ√≠a</strong><br>
                <small>Precios REE Espa√±a</small>
            </div>
            <div class="feature">
                <strong>üå°Ô∏è Clima</strong><br>
                <small>Datos AEMET Linares</small>
            </div>
            <div class="feature">
                <strong>ü§ñ ML</strong><br>
                <small>Predicciones inteligentes</small>
            </div>
        </div>
        
        <p><a href="/dashboard" class="link">üöÄ Acceder al Dashboard</a></p>
        
        <div class="footer">
            <div>üîí Conexi√≥n Segura Tailscale | üìä Solo Dashboard</div>
            <div>üìç F√°brica: Linares, Andaluc√≠a, Espa√±a (38.151¬∞N, -3.629¬∞W)</div>
        </div>
    </div>
</body>
</html>';
        }
    }
}
events {
    worker_connections 1024;
}

http {
    # Configuración básica
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Variable para resolver dinámicamente el upstream
    resolver 127.0.0.11 valid=30s ipv6=off;

    # Servidor HTTPS - Development Dashboard
    server {
        listen 80;
        listen [::]:80;
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name ${TAILSCALE_DOMAIN};

        # Certificados SSL automáticos de Tailscale
        ssl_certificate /var/lib/tailscale/certs/${TAILSCALE_DOMAIN}.crt;
        ssl_certificate_key /var/lib/tailscale/certs/${TAILSCALE_DOMAIN}.key;

        # Configuración SSL moderna
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        # Redirección HTTP -> HTTPS
        if ($scheme != "https") {
            return 301 https://$host$request_uri;
        }

        # REDIRIGIR ROOT A DASHBOARD ESTÁTICO
        location = / {
            return 302 /static/index.html;
        }

        # DASHBOARD - Redirigir a estático
        location = /dashboard {
            return 302 /static/index.html;
        }

        # API endpoints necesarios para el dashboard
        location /dashboard/complete {
            set $upstream chocolate_factory_dev:8000;
            proxy_pass http://$upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /dashboard/heatmap {
            set $upstream chocolate_factory_dev:8000;
            proxy_pass http://$upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Sprint 08: Optimization endpoints
        location /optimize/ {
            set $upstream chocolate_factory_dev:8000;
            proxy_pass http://$upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Sprint 09: Predictive Insights endpoints
        location /insights/ {
            set $upstream chocolate_factory_dev:8000;
            proxy_pass http://$upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Sprint 11: Chatbot BI endpoints
        location /chat/ {
            set $upstream chocolate_factory_dev:8000;
            proxy_pass http://$upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Permitir recursos estáticos del dashboard
        location ~ ^/(static|css|js|images|fonts)/ {
            set $upstream chocolate_factory_dev:8000;
            proxy_pass http://$upstream;
            proxy_set_header Host $host;
            add_header Cache-Control "public, max-age=86400";
        }

        # Favicon
        location = /favicon.ico {
            return 204;
            access_log off;
        }

        # BLOQUEAR APIs administrativas - Seguridad
        location ~ ^/(docs|redoc|openapi\.json|predict|mlflow|ree|aemet|weather|init|gaps|models|scheduler|influxdb) {
            return 403 '<!DOCTYPE html>
<html>
<head>
    <title>🧪 Development Environment - Restricted</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #8B4513; }
        p { color: #555; }
        .link { color: #0066cc; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Development Environment</h1>
        <p>⚠️ Administrative APIs are restricted</p>
        <p><a href="/dashboard" class="link">👉 Access Development Dashboard</a></p>
    </div>
</body>
</html>';
        }

        # Health check
        location /nginx-health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Mensaje por defecto para rutas desconocidas
        location / {
            return 403 '<!DOCTYPE html>
<html>
<head>
    <title>🧪 Development - Dashboard Only</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 3rem; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        h1 { color: #667eea; }
        .link { color: white; text-decoration: none; font-weight: bold; padding: 1rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50px; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Development Environment</h1>
        <p>Chocolate Factory Development Dashboard</p>
        <p><a href="/dashboard" class="link">🚀 Access Dashboard</a></p>
    </div>
</body>
</html>';
        }
    }
}

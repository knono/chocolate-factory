# =============================================================================
# TFM CHOCOLATE FACTORY - DOCKER COMPOSE
# =============================================================================
# Arquitectura de 4 contenedores para la simulaci贸n y monitoreo
# de la f谩brica de chocolate
#
#  SECRETS MANAGEMENT:
# - Usa SOPS (Secrets OPerationS) para gesti贸n de secrets encriptados
# - Antes de levantar servicios: ./decrypt-secrets.sh (genera .env desde secrets.enc.yaml)
# - Variables de entorno: ${secret_name} interpoladas desde .env
# - Documentaci贸n: docs/SOPS_SECRETS_MANAGEMENT.md
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # 1. EL CEREBRO AUTNOMO - FastAPI + APScheduler
  # ---------------------------------------------------------------------------
  fastapi-app:
    build:
      context: .
      dockerfile: docker/fastapi.Dockerfile
    container_name: chocolate_factory_brain
    ports:
      - "${FASTAPI_PORT:-8000}:8000"
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TZ:-Europe/Madrid}
      - PYTHONPATH=/app
      # APIs Externas (from SOPS-decrypted .env)
      - REE_API_TOKEN=${ree_api_token}
      - AEMET_API_KEY=${aemet_api_key}
      - OPENWEATHERMAP_API_KEY=${openweathermap_api_key}
      - ANTHROPIC_API_KEY=${anthropic_api_key}
      # Conexiones internas Docker
      - INFLUXDB_URL=${INFLUXDB_URL_DOCKER}
      - INFLUXDB_TOKEN=${influxdb_token}
      - INFLUXDB_ORG=${INFLUXDB_ORG}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET}
      # Sprint 18: Tailscale Authentication
      - TAILSCALE_AUTH_ENABLED=${TAILSCALE_AUTH_ENABLED:-true}
      - TAILSCALE_ADMINS=${TAILSCALE_ADMINS}
    volumes:
      - ./data:/app/data
      - ./src/configs:/app/configs
      - ./src/fastapi-app/services:/app/services  # Bind mount completo del directorio services
      - ./src/fastapi-app/main.py:/app/main.py
      - ./src/fastapi-app/startup_tasks.py:/app/startup_tasks.py
      - ./docker/services/fastapi/logs:/app/logs
      - ./models:/app/models
      - ./scripts:/app/scripts
      - ./.claude:/app/.claude  # Business logic rules and settings
      - tailscale_state:/var/lib/tailscale:ro  # Sprint 13: Read-only access to Tailscale state for CLI
      # Sprint 03: Service Layer architecture (legacy - will be migrated to Phase 1 structure)
      # - ./src/api:/app/api
      # - ./src/services:/app/src_services
      # - ./src/repositories:/app/repositories
      # - ./src/core:/app/core
      # - ./src/models:/app/src_models
      # - ./src/ml:/app/ml
      # Sprint 05: Static dashboard files
      - ./static:/app/static
      # Phase 1: Clean Architecture foundation (api_architect refactoring)
      - ./src/fastapi-app/api:/app/api
      - ./src/fastapi-app/domain:/app/domain
      - ./src/fastapi-app/infrastructure:/app/infrastructure
      - ./src/fastapi-app/core:/app/core
      - ./src/fastapi-app/tasks:/app/tasks
      - ./src/fastapi-app/dependencies.py:/app/dependencies.py
      - ./src/fastapi-app/test_foundation.py:/app/test_foundation.py
      - ./src/fastapi-app/test_infrastructure.py:/app/test_infrastructure.py
      - ./src/fastapi-app/test_architecture.py:/app/test_architecture.py
    depends_on:
      - influxdb
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # 2. EL ALMACN PRINCIPAL - InfluxDB
  # ---------------------------------------------------------------------------
  influxdb:
    image: influxdb:2.7
    container_name: chocolate_factory_storage
    ports:
      - "${INFLUXDB_PORT:-8086}:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USER}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${influxdb_admin_password}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${influxdb_token}
    volumes:
      - ./docker/services/influxdb/data:/var/lib/influxdb2
      - ./docker/services/influxdb/config:/etc/influxdb2
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 3


  # ---------------------------------------------------------------------------
  # 5. EL MONITOR - Dashboard integrado en FastAPI (Reflex reemplaza Node-RED)
  # ---------------------------------------------------------------------------
  # Dashboard ahora servido desde http://localhost:8000/dashboard

# =============================================================================
# ESTRUCTURA DE DIRECTORIOS PARA BIND MOUNTS
# =============================================================================
# Los datos ahora se mapean directamente a ./docker/services/[servicio]
# para acceso directo, backups y monitoreo en tiempo real

# =============================================================================
# RED INTERNA
# =============================================================================
networks:
  backend:
    driver: bridge
    driver_opts:
      # evita fragmentaci贸n sobre Tailscale
      com.docker.network.driver.mtu: "1280"
    ipam:
      driver: default
      config:
        - subnet: "192.168.100.0/24"